<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.autoMotiveMes.mapper.order.WorkOrderMapper">
    <!-- 工单列表查询 -->
    <select id="listWorkOrders" resultType="com.autoMotiveMes.dto.order.ListWorkOrderResponseDto">
        SELECT
        wo.order_id,
        wo.order_no,
        e.equipment_code,
        e.equipment_name,
        CASE wo.order_type
        WHEN '生产' THEN '生产工单'
        WHEN '维护' THEN '维护工单'
        WHEN '维修' THEN '维修工单'
        END AS order_type,
        wo.content,
        CASE wo.status
        WHEN '待处理' THEN '待处理'
        WHEN '进行中' THEN '进行中'
        WHEN '已完成' THEN '已完成'
        END AS status,
        creator.real_name AS creator_name,
        assignee.real_name AS assignee_name,
        DATE_FORMAT(wo.create_time, '%Y-%m-%d %H:%i') AS create_time,
        DATE_FORMAT(wo.finish_time, '%Y-%m-%d %H:%i') AS finish_time,
        (SELECT COUNT(*) FROM scheduling_plan sp WHERE sp.order_id = wo.order_id) AS plan_count
        FROM work_order wo
        JOIN equipment e ON wo.equipment_id = e.equipment_id
        LEFT JOIN sys_user creator ON wo.creator_id = creator.user_id
        LEFT JOIN sys_user assignee ON wo.assignee_id = assignee.user_id
        <where>
            <if test="dto.orderNo != null and dto.orderNo != ''">
                AND wo.order_no LIKE CONCAT('%', #{dto.orderNo}, '%')
            </if>
            <if test="dto.equipmentCode != null and dto.equipmentCode != ''">
                AND e.equipment_code LIKE CONCAT('%', #{dto.equipmentCode}, '%')
            </if>
            <if test="dto.status != null and dto.status != ''">
                AND wo.status = #{dto.status}
            </if>
            <if test="dto.orderType != null and dto.orderType != ''">
                AND wo.order_type = #{dto.orderType}
            </if>
            <if test="dto.creatorName != null and dto.creatorName != ''">
                AND creator.real_name LIKE CONCAT('%', #{dto.creatorName}, '%')
            </if>
            <if test="dto.assigneeName != null and dto.assigneeName != ''">
                AND assignee.real_name LIKE CONCAT('%', #{dto.assigneeName}, '%')
            </if>
            <if test="dto.createTimeStart != null">
                AND wo.create_time >= #{dto.createTimeStart}
            </if>
            <if test="dto.createTimeEnd != null">
                AND wo.create_time &lt;= #{dto.createTimeEnd}
            </if>
        </where>
        ORDER BY wo.create_time DESC
    </select>

    <!-- 工单详情查询 -->
    <select id="getWorkOrderDetail" resultType="com.autoMotiveMes.dto.order.WorkOrderDetailResponseDto">
        SELECT
            wo.order_id,
            wo.order_no,
            e.equipment_code,
            e.equipment_name,
            wo.order_type,
            wo.content,
            wo.status,
            creator.real_name AS creator_name,
            assignee.real_name AS assignee_name,
            DATE_FORMAT(wo.create_time, '%Y-%m-%d %H:%i') AS create_time,
            DATE_FORMAT(wo.finish_time, '%Y-%m-%d %H:%i') AS finish_time,
            (SELECT
                 JSON_ARRAYAGG(
                         JSON_OBJECT(
                                 'planDate', DATE_FORMAT(plan_date, '%Y-%m-%d'),
                                 'startTime', start_time,
                                 'endTime', end_time,
                                 'progress', progress
                         )
                 )
             FROM scheduling_plan
             WHERE order_id = #{orderId}) AS schedules,
            (SELECT
                 JSON_OBJECT(
                         'planDate', DATE_FORMAT(plan_date, '%Y-%m-%d'),
                         'cycleDays', cycle_days,
                         'content', content
                 )
             FROM maintenance_plan
             WHERE equipment_id = wo.equipment_id
             ORDER BY plan_date DESC LIMIT 1) AS maintenance_info
        FROM work_order wo
                 JOIN equipment e ON wo.equipment_id = e.equipment_id
                 LEFT JOIN sys_user creator ON wo.creator_id = creator.user_id
                 LEFT JOIN sys_user assignee ON wo.assignee_id = assignee.user_id
        WHERE wo.order_id = #{orderId}
    </select>
</mapper>